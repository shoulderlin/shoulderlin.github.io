<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è·¨ PDF æœå°‹</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    body {
      font-family: "Helvetica Neue", sans-serif;
      background: #f2f2f2;
      padding: 20px;
      color: #333;
    }
    h1 {
      color: #0057a3;
    }
    input[type="file"],
    input[type="text"],
    button {
      padding: 10px;
      margin: 5px 0;
      font-size: 16px;
    }
    #uploaded-list {
      margin-top: 15px;
      background: #fff;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
      display: none; /* é è¨­éš±è—æª”æ¡ˆæ¸…å–® */
    }
    #file-list {
      list-style-type: none;
      padding: 0;
    }
    #results {
      margin-top: 20px;
    }
    .pdf-card {
      background: #ffffff;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 8px;
      border-left: 5px solid #0057a3;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .result-item {
      margin-top: 10px;
      padding: 8px;
      border-left: 3px solid #ccc;
      background: #f9f9f9;
    }
    .highlight {
      background-color: yellow;
      font-weight: bold;
    }
    a {
      color: #0077cc;
      text-decoration: none;
    }
    a:hover {
      text-decoration: underline;
    }
    footer {
      margin-top: 40px;
      font-size: 14px;
      color: gray;
      text-align: center;
    }
  </style>
</head>
<body>

  <h1>ğŸ“„ è·¨ PDF æœå°‹å·¥å…·</h1>

  <input type="file" id="pdf-upload" multiple accept="application/pdf">
  <br>
  <input type="text" id="search-input" placeholder="è¼¸å…¥é—œéµå­—ä¾†æœå°‹ PDF...">
  <button onclick="searchInPDFs()">ğŸ” æœå°‹</button>
  
  <!-- æª”æ¡ˆæ¸…å–®å€åŸŸ -->
  <button onclick="toggleFileList()">ğŸ“‚ é¡¯ç¤º/éš±è—å·²ä¸Šå‚³æª”æ¡ˆ</button>
  <div id="uploaded-list">
    <h3>å·²ä¸Šå‚³æª”æ¡ˆï¼š</h3>
    <ul id="file-list"></ul>
  </div>

  <!-- æœå°‹çµæœå€åŸŸ -->
  <div id="results"></div>

  <footer>
    <hr>
    <p>
      ğŸ“Œ æœ¬å·¥å…·ç‚ºç´”å‰ç«¯æ‡‰ç”¨ï¼Œæ‰€æœ‰æ“ä½œçš†åœ¨ç€è¦½å™¨æœ¬åœ°ç«¯åŸ·è¡Œï¼Œä¸æœƒä¸Šå‚³ä»»ä½•æª”æ¡ˆã€‚è«‹å‹¿ä¸Šå‚³åŒ…å«æ©Ÿå¯†ã€å€‹è³‡æˆ–å•†æ¥­æ•æ„Ÿè³‡è¨Šä¹‹æ–‡ä»¶ã€‚<br>
      ä½¿ç”¨è€…éœ€è‡ªè² é¢¨éšªï¼Œé–‹ç™¼è€…ä¸è² è³‡æ–™ä¿ç®¡è²¬ä»»ã€‚<br>
      
      ğŸ“Œ æœ¬ç¶²ç«™ä½¿ç”¨äº†é–‹æºç¨‹å¼ç¢¼ï¼Œä¸¦éµå¾ª <a href="http://www.apache.org/licenses/LICENSE-2.0" target="_blank">Apache 2.0 æˆæ¬Šæ¢æ¬¾</a>ã€‚
    è©³æƒ…è«‹åƒè¦‹æˆæ¬Šé é¢ã€‚
    </p>
  </footer>

  <script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

    let pdfFiles = [];

    // æª”æ¡ˆä¸Šå‚³è™•ç†
    document.getElementById('pdf-upload').addEventListener('change', function (e) {
      pdfFiles = Array.from(e.target.files);
      const fileList = document.getElementById('file-list');
      fileList.innerHTML = '';
      pdfFiles.forEach(file => {
        const li = document.createElement('li');
        li.textContent = file.name;
        fileList.appendChild(li);
      });
    });

    // é¡¯ç¤º/éš±è—æª”æ¡ˆæ¸…å–®
    function toggleFileList() {
      const fileList = document.getElementById('uploaded-list');
      fileList.style.display = (fileList.style.display === 'none') ? 'block' : 'none';
    }

    // å–å¾— PDF æ–‡å­—
    async function getTextFromPDF(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let textContent = [];

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        const strings = content.items.map(item => item.str).join(' ');
        textContent.push({ page: i, text: strings });
      }

      return textContent;
    }

    // æœå°‹ PDF æª”æ¡ˆ
    async function searchInPDFs() {
      const keyword = document.getElementById('search-input').value.trim().toLowerCase();
      const resultsContainer = document.getElementById('results');
      resultsContainer.innerHTML = '';

      if (!keyword) {
        resultsContainer.textContent = 'âš ï¸ è«‹è¼¸å…¥é—œéµå­—å†æœå°‹';
        return;
      }

      let allResults = [];
      
      for (let file of pdfFiles) {
        const contentArray = await getTextFromPDF(file);
        let fileResults = [];

        contentArray.forEach(({ page, text }) => {
          const lowerText = text.toLowerCase();
          const keywordIndex = lowerText.indexOf(keyword);
          if (keywordIndex >= 0) {
            const start = Math.max(0, keywordIndex - 50);
            const end = Math.min(text.length, keywordIndex + 150);
            let context = text.substring(start, end);
            context = context.replace(new RegExp(keyword, 'gi'), match => `<span class="highlight">${match}</span>`);
            fileResults.push(`
              <div class="result-item">
                <strong>ç¬¬ ${page} é ï¼š</strong> ${context}
              </div>
            `);
          }
        });

        if (fileResults.length > 0) {
          allResults.push({
            fileName: file.name,
            fileResults: fileResults,
            file: file
          });
        }
      }

      if (allResults.length === 0) {
        resultsContainer.innerHTML = '<p>âŒ æ²’æœ‰æ‰¾åˆ°ä»»ä½•çµæœã€‚</p>';
        return;
      }

      // é¡¯ç¤ºæ‰€æœ‰çµæœ
      allResults.forEach(result => {
        const card = document.createElement('div');
        card.className = 'pdf-card';
        const blobURL = URL.createObjectURL(result.file);
        card.innerHTML = `
          <h3><a href="${blobURL}" target="_blank">${result.fileName}</a></h3>
          ${result.fileResults.join('')}
        `;
        resultsContainer.appendChild(card);
      });
    }
  </script>
</body>
</html>
